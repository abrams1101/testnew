name: Test00
on: [push]

env:
  US_AWS_REGION : "us-east-1"
  
# Required to get the ID Token that will be used for OIDC
permissions:
  id-token: write
  contents: read    # This is required for actions/checkout

jobs:
  deploy_us:
    name: ECR deployment on US region
    runs-on: ubuntu-latest
    environment: dev
    steps:
    # Uses our OIDC AWS Provider to retrieve credentials useful for this run, the credentials are scoped to a repository name and branch
    # the main branch is the only branch that's trusted to fetch administrator credentials, all the other branches can retrieve read-only
    # creds for the run, this can be changed on AWS side if there's an special use case.
    - name: Checkout repo
      uses: actions/checkout@v2
  
    - name: Configure AWS credentials
      id: aws_credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{ secrets.OIDC_ROLE }}
        aws-region: ${{ env.US_AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Get current timestamp
      id: timestamp
      run: echo "::set-output name=timestamp::$(date +%Y%m%d%S)"

    - name: Step02
      uses: abrams1101/gh_actions/ecr@main
      with:
        REPOSITORY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_REPO_NAME: edison-custom-infra-container
        IMAGE_TAG: latest
        COMMIT_HASH: ${{ github.sha }}
        BUILD_TIMESTAMP: ${{ steps.timestamp.outputs.timestamp }}
      
